# 能力

QUIC 在功能上等价于 TCP + TLS + HTTP/2，但基于 UDP 实现。

- 连接建立延迟
- 灵活的拥塞控制
- 多路复用而不存在队首阻塞
- 认证和加密的首部和载荷
- 流和连接的流量控制
- 连接迁移



# 名词介绍

- “客户端”：初始化 QUIC 连接的端点。
- “服务器”：接受进入的 QUIC 连接的端点。
- “端点”：连接的客户端或服务器端。
- “流”：QUIC 连接中穿过一个逻辑通道的双向字节流。
- “连接”：两个 QUIC 端点之间的会话，它具有一个单独的加密上下文且包含多路复用流。
- “连接ID”：QUIC 连接的标识符。
- “QUIC包”：经过良好格式化的 UDP 载荷，可由 QUIC 接收者解析。本文档中的 QUIC 包大小指 UDP 载荷大小。



# quic包

QUIC 具有特殊包和普通包。有两种类型特殊包：版本协商包 (Version Negotiation Packets) 和 公共复位包 (Public Reset Packets)，普通包包含帧。

QUIC 包的大小应该适配在路径的 MTU 以避免IP分片。当前 QUIC 实现为 IPv6 使用 1350 字节的最大QUIC包大小，IPv4 使用1370字节。两个大小都没有 IP 和 UDP 过载。

## 公共包头

```
--- src
     0        1        2        3        4            8
+--------+--------+--------+--------+--------+---    ---+
| Public |    Connection ID (64)    ...                 | ->
|Flags(8)|      (optional)                              |
+--------+--------+--------+--------+--------+---    ---+

     9       10       11        12   
+--------+--------+--------+--------+
|      QUIC Version (32)            | ->
|         (optional)                |                           
+--------+--------+--------+--------+


    13       14       15        16      17       18       19       20
+--------+--------+--------+--------+--------+--------+--------+--------+
|                        Diversification Nonce                          | ->
|                              (optional)                               |
+--------+--------+--------+--------+--------+--------+--------+--------+

    21       22       23        24      25       26       27       28
+--------+--------+--------+--------+--------+--------+--------+--------+
|                   Diversification Nonce Continued                     | ->
|                              (optional)                               |
+--------+--------+--------+--------+--------+--------+--------+--------+

    29       30       31        32      33       34       35       36
+--------+--------+--------+--------+--------+--------+--------+--------+
|                   Diversification Nonce Continued                     | ->
|                              (optional)                               |
+--------+--------+--------+--------+--------+--------+--------+--------+

    37       38       39        40      41       42       43       44
+--------+--------+--------+--------+--------+--------+--------+--------+
|                   Diversification Nonce Continued                     | ->
|                              (optional)                               |
+--------+--------+--------+--------+--------+--------+--------+--------+


    45      46       47        48       49       50
+--------+--------+--------+--------+--------+--------+
|           Packet Number (8, 16, 32, or 48)          |
|                  (variable length)                  |
+--------+--------+--------+--------+--------+--------+

---
```

公共包头由公共标识、连接ID、quic版本号和包号等字段组成。

- **公共标记（Public Flags）**：
  - 0x01 = PUBLIC_FLAG_VERSION。这个标记的含义与包是由服务器还是客户端发送的有关。当由客户端发送时，设置它表示头部包含 QUIC 版本 (参考下面的说明)。客户端必须在所有的包中设置这个位，直到客户端收到来自服务器的确认，同意所提议的版本。服务器通过发送不设置该位的包来表示同意版本。当这个位由服务器设置时，包是版本协商包。版本协商在后面更详细地描述。
  - 0x02 = PUBLIC_FLAG_RESET。设置来表示包是公共复位包。
  - 0x04 = 表明在头部中存在 32字节的多样化随机数。
  - 0x08 = 表明包中存在完整的8字节连接ID。必须为所有包设置该位，直到为给定方向协商出不同的值 (比如，客户端可以请求包含更少字节的连接ID)。
  - 0x30 处的两位表示每个包中存在的数据包编号的低位字节数。这些位只用于帧包。没有包号的公共复位和版本协商包 (由服务器发送) ，不使用这些位，且必须被设置为0。这2位的掩码：
    - 0x30 表示包号占用6个字节。
    - 0x20 表示包号占用4个字节。
    - 0x10 表示包号占用2个字节。
    - 0x00 表示包号占用1个字节。
    - 0x40 为多路径使用保留。
    - 0x80 当前未使用，且必须被设置为0。
- **连接ID**：这是客户端选择的无符号64位统计随机数，该数字是连接的标识符。由于 QUIC 的连接被设计为，即使客户端漫游，连接依然保持建立状态，因而 IP 4元组（源IP，源端口，目标IP，目标端口）可能不足以标识连接。对每个传输方向，当4元组足以标识连接时，连接ID可以省略。
- **QUIC版本**：表示 QUIC 协议版本的32位不透明标记。只有在公共标记包含 FLAG_VERSION（比如 public_flags & FLAG_VERSION !=0） 时才存在。客户端可以设置这个标记，并 准确 包含一个提议版本，同时包含任意的数据（与该版本一致）。当客户端提议的版本不支持时，服务器可以设置这个标记，并可以提供一个可接受版本的列表（0或多个），但 一定不能(MUST not) 在版本信息之后包含任何数据。最近的实验版本的版本值示例包括 “Q025”，它对应于 byte 9 包含 ‘Q”，byte 10 包含 ‘0”，等等。[参考本文末尾的不同版本变化列表。]
- **包号**：包号的低 8，16，32，或 48 位，基于公共标记的 FLAG_?BYTE_SEQUENCE_NUMBER 标记被设置为什么。每个普通包（与特别的公共复位和版本协商包相反）由发送者分配包号。由某一端发送的首包包号应该为1，后续每个包的包号应该比前一个的大1。



### 公共包头解析处理

```
--- src
Check the public flags in public header
                 |
                 |
                 V
           +--------------+
           | Public Reset |    YES
           | flag set?    |---------------> Public Reset Packet
           +--------------+
                 |
                 | NO
                 V
           +------------+          +-------------+
           | Version    |   YES    | Packet sent |  YES
           | flag set?  |--------->| by server?  |--------> Version Negotiation
           +------------+          +-------------+               Packet
                 |                        |
                 | NO                     | NO
                 V                        V
           Regular Packet         Regular Packet with 
                              QUIC Version present in header
---
```



### 版本协议包

**只有服务器会发送版本协商包，用于向客户端提供版本协商**。版本协商包以8位的公共标记和64位的连接ID开始。公共标记必须设置PUBLIC_FLAG_VERSION，并指明64位的连接ID。版本协商包的其余部分是服务器支持的版本的4字节列表。

```
--- src
     0        1        2        3        4        5        6        7       8
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| Public |    Connection ID (64)                                                 | ->
|Flags(8)|                                                                       |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+

     9       10       11        12       13      14       15       16       17
+--------+--------+--------+--------+--------+--------+--------+--------+---...--+
|      1st QUIC version supported   |     2nd QUIC version supported    |   ...
|      by server (32)               |     by server (32)                |             
+--------+--------+--------+--------+--------+--------+--------+--------+---...--+

---
```



### 公共复位包

#### todo该包的意义



### 普通包

普通包也分帧包和FEC包。包由私有头部和包文组成。

#### todo普通包的两种包作用



#### 私有头部

普通包已经过认证和加密。公共头部已认证但未加密，从包的其余部分已加密。紧随公共头部之后，普通包包含 AEAD（authenticated encryption and associated data）数据。要解释内容，这些数据必须先解密。解密之后，明文从一个私有头部开始。

```
        0        1
   +--------+--------+
   |Private | FEC (8)|
   |Flags(8)|  (opt) |
   +--------+--------+
```

私有头部包含两个字段：

* 私有标记(private flags)：

  * 0x01 = FLAG_ENTROPY 
    * 对于数据包，标识这个包包含一位的entropy
    * 对于fec包，标识包含受保护包的entropy的异或(for fec packets, contains the xor of the entropy of protected packets)
  * 0x02 = FLAG_FEC_GROUP 标识fec字节存在
  * 0x04 = FLAG_FEC 标识该包位fec包
  
* FEC(FEC Group Number Offset): 该字段仅在私有标记**包含**FLAG_FEC_GROUP时出现。所有FEC group中的数据包必须将包号编码为相同的值
  * FEC分组第一个包的包号位`FEC Group Number`。`FEC Group Number =FEC Group Number Offse - current packet number `

#### 帧包

对于帧包，在私有头部之后跟随的是一组帧类型类型为前缀的帧。

```
   +--------+---...---+--------+---...---+
   | Type   | Payload | Type   | Payload |
   +--------+---...---+--------+---...---+
```

#### FEC包

```
   FEC packets (those packets with FLAG_FEC set) have a payload that
   simply contains an XOR of the null-padded payload of each Data Packet
   in the FEC group.  FEC packets must also have FLAG_FEC_GROUP set
```

对于FEC包，私有头部后续仅跟随着FEC group中每个数据包负载的异或值。

```
   +-----...----+
   | Redundancy |
   +-----...----+
```



# 连接生命周期

## 建立连接



## 数据传输

### 流

#### 流帧的创建流

#### 流帧使用约束



## 连接与流的中断

## 显式中断

通过帧位fin进行流中断。通过CONNECTION_CLOSE帧关闭连接

## 隐式中断



# 帧类型和格式

帧类型字节有两种解释，导致两种帧类型：特殊帧类型，和普通帧类型。特殊帧类型在**帧类型字节中	同时编码帧类型和对应的标记**，而普通帧类型简单地使用帧类型字节。

## 特殊帧

```
--- src
   +------------------+-----------------------------+
   | Type-field value |     Control Frame-type      |
   +------------------+-----------------------------+
   |     1fdooossB    |  STREAM                     |
   |     01ntllmmB    |  ACK                        |
   |     001xxxxxB    |  CONGESTION_FEEDBACK        |
   +------------------+-----------------------------+
---
```

### 流帧

```
--- src
     0        1       …               SLEN
+--------+--------+--------+--------+--------+
|Type (8)| Stream ID (8, 16, 24, or 32 bits) |
|        |    (Variable length SLEN bytes)   |
+--------+--------+--------+--------+--------+

  SLEN+1  SLEN+2     …                                         SLEN+OLEN   
+--------+--------+--------+--------+--------+--------+--------+--------+
|   Offset (0, 16, 24, 32, 40, 48, 56, or 64 bits) (variable length)    |
|                    (Variable length: OLEN  bytes)                     |
+--------+--------+--------+--------+--------+--------+--------+--------+

  SLEN+OLEN+1   SLEN+OLEN+2
+-------------+-------------+
| Data length (0 or 16 bits)|
|  Optional(maybe 0 bytes)  |
+------------+--------------+
---
```

一个流帧必须总是要么具有非零的数据长度，要么设置了FIN位。流帧首部中的字段如下：

- 帧类型

  ：帧类型字节是一个包含多种标记 (1fdooossB) 的8位值：

  - 最左边的位必须被设为 1 以指明这是一个STREAM帧。
  - ‘f’ 位是FIN位。当被设置为 1 时，这个位表明发送者已经完成在流上的发送并希望 “half-close（半关闭）”（稍后将详细描述）。本文档的后面将更详细地描述。
  - ‘d’ 位表明STREAM头部中是否包含帧的数据长度。当设为0时，这个字段表明STREAM帧扩展至包的结尾。
  - 接下来的三个’ooo’位编码Offset头部字段的长度为0，16，24，32，40，48，56，或64位长。
  - 接下来的两个 ‘ss’ 位编码流 ID头部字段的长度为 8，16，24，或32位长。

- **流 ID**：一个大小可变的流唯一的无符号ID。

- **偏移**：一个大小可变的无符号数字指定流中这块数据的字节偏移。

- **数据长度**：一个可选的16位无符号数字指定这个流帧中数据的长度。只有当包是 “全大小(full-sized)” 包时，才应该省略长度，来避免填充破坏的风险。

#### 疑问

为什么流帧会由数据字节偏移以及数据长度，流帧的数据内容是是什么？



### ACK帧

ACK帧被发送用以通知对端哪些包已经收到，还有哪些包依然被接收者认为丢失了（丢失包的内容可能需要被重发）。ACK帧包含1 到 256 个ack块。Ack块是确认的包的范围。

```
      0        1                           N
 +--------+--------+---------------------------------------------------+
 |  Type  |Received|                Largest Observed                   |
 |  (8)   |Entropy |              (8, 16, 32, or 48 bits)              |
 +--------+--------+---------------------------------------------------+

    N+1       N+2      N+3      N+4                   N+8
 +--------+--------+---------+--------+--------------------------------+
 |    Ack Delay    |   Num   | Delta  |        First Timestamp         |
 |     Time (16)   |Timestamp|Largest |           (32 bits)            |
 |                 |   (8)   |Observed|                                |
 +--------+--------+---------+--------+--------------------------------+

    N+9         N+11 - X
 +--------+-------------------+
 | Delta  |   Time Since      |
 |Largest | Previous Timestamp|  <-- Repeat (NumTimestamp - 1) times
 |Observed|     (16 bits)     |
 +--------+-------------------+

     X                        X+1 - Y                           Y+1
 +--------+-------------------------------------------------+--------+
 | Number |     Missing Packet Sequence Number Delta        | Range  |
 | Ranges |           (8, 16, 32, or 48 bits)               | Length |
 | (opt)  |        (repeats Number Ranges times)            |(Repeat)|
 +--------+-------------------------------------------------+--------+

     Y+2                       Y+3 - Z
 +--------+-----------------------------------------------------+
 | Number |            Revived Packet Number                    |
 | Revived|  (8, 16, 32, or 48 bits, same as Largest Observed)  |
 | (opt)  |        (repeats Number Revived times)               |
 +--------+-----------------------------------------------------+
```

#### 疑问

该帧如何使用？



## 普通帧

```
--- src
   +------------------+-----------------------------+
   | Type-field value |     Control Frame-type      |
   +------------------+-----------------------------+
   |     1fdooossB    |  STREAM                     |
   |     01ntllmmB    |  ACK                        |
   |     001xxxxxB    |  CONGESTION_FEEDBACK        |
   +------------------+-----------------------------+
---
```