# Devops

什么是Devops我也不知道。

重要的是拉近开发、测试、运维和运营的距离，降低沟通成本，将流程清晰、文档化、自动化，对整体流程问题上浮到最上层，让应该关注的人可以关注。而不是让一人充当多种角色。



# CI/CD

持续集成是一种在频繁集成场景下，自动且快速集成的策略。微服务的持续集成需要一种策略将微服务包融合到大系统包中，在**版本管理上微服务间的版本甚至可能不同**，但必须是**兼容的**。

持续部署/发布在持续集成的版本兼容上进一步扩展做到包的自动、快速部署。持续部署也分为多种目的，不同目的下持续部署需要考虑环境资源、**服务隔离**、部署策略、服务清理等问题。持续发布需要考虑发布策略，版本回滚等问题。

## CI

一般而言，发布某个系统，意味着发布整个系统包(后称大包)。而在微服务场景下大包往往由多个微服务包(小包)集成。对于大包的出包，一般指对众多小包的或自动或集成程序有意识的集成。

小包出包一般会经历**服务定义**、服务构建、包测试、包归档等流程。

* 服务定义目的是为了声明自身服务的能力以及相关协议
* 服务构建是将微服务相关源码打包为用户可执行程序，用于后续集成与发布
* 包测试在出包后首先需要进行一定的测试以初步检验包的质量
* 包归档往往是对包进行保存或自动集成到打包

## CD

持续部署对小包的自动化，快速和持续的按**一定策略**部署特定目的环境上与环境上的已有系统集成。

持续部署遇到的问题在于环境定义、环境资源、环境准备、**环境系统配置**、**部署策略**、**版本回滚**、**服务清理(环境资源回收)**等。

不同定义的环境用于不同的目的，因此在CD上有所差异，面临的问题也有所不同。



# 目前的集成模型

目前我们基于TBD分支模型开发，基于需求分支进行需求开发，基于主线分支进行持续集成与发布。基于分支做自动构建，但是仅基于主线分支进行发布。

根据目前的开发流程(可能有误)，我们的集成目前仅局限从**需求分支到主线分支**的集成。

在测试流程上系统的联调测试要么是基于需求分支**自行**搭建一套**完全的环境**，要么在合并到主线分支后进行。前者费力且容易发生**版本兼容漏测**，后者会将潜在问题的发现**延后到集成甚至是版本发布**(所以发版事情多，发现的问题也多，时间又紧，需要加班)。



# 环境定义

在引入CD前，我们首选需要做的事情是对自动部署环境进行定义，为各个环境赋予特定用途，根据环境定义决定对应的部署策略，准备环境资源，着手准备环境，配置环境系统配置

针对Cloud场景定义5种环境：

1. 开发联调环境：用于开发进行初步的联调、自测与接口测试等，测试看情况参与。该环境自动集成需求分支。
   * 开发性能测试环境：该环境主要用于对不需要依赖其他服务时，服务自身能力的性能测试，建议仅提供充足的资源，不提供CD，由开发和测试根据具体情况决定是否进行，由谁进行，不计入5种环境中
2. 集成环境：用于需求分支包成进入大包后的集成测试，环境仅需要满足整个系统的最低资源配置定义，各个微服务部署均采用默认参数配置
3. 性能测试：用于对系统局部和整体的性能测试，环境资源充足。部署的服务包与集成环境相同，但部署的参数在CD时仍采用默认参数，但需要特定手段允许调整。
4. 预发环境：提供整体系统上线前的试营、整体验证性工作和一些质量验证工作，与生产环境配置相同。多套预发环境对应不同重点客户，目前仅考虑一套对应共有云生产环境。
5. 生产环境：在公有云上提供客户使用。



# 部署策略

## 联调开发与集成环境

目前考虑开发联调环境与集成环境主要目的是进行功能测试，使用同一套环境。

隔离策略为**不同环境间使用不同命名空间、租户名称隔离，各自命名空间和租户名称为分支名称**。集成环境对应为该环境的主空间，暂定为"integration"。

服务依赖上，各个命名空间下的服务**优先使用本空间下的其他服务**，如果本空间下不存在对应则使用**主空间integration**的对应服务。(因此我们需要服务注册、多级配置合并、配置订阅、配置分发等底层平台能力，和应用层的热更新能力)。

在服务通信上形成如下的拓扑，每个特性环境对应一个联调开发环境，公共基础环境对应集成环境。

![dev-feat](E:\study\distribute system\devops\images\dev-feat.png)

ps: 在先到可以的实现上，并不能完美的实现该拓扑，例如特性环境-1中的服务B调用服务A后，如果需要服务A回调特性环境-1中的服务B需要更强的路由能力甚至是应用层增强，目前可能会回调到公共基础环境的服务B。

由于两个环境的底层为同一个环境，而可能同时开发多个需求，因此需要为该底层环境配置**充足的资源**。

### 实现

拓扑图形成方案：

 	1. 系统配置中心划分多个租户，每个分支各自拥有一个租户，以集成分支为主配置空间，作为默认配置。各个租户默认订阅自身租户空间下的配置
 	 * 假设一共有4个服务，此时配置中心有配置`i:[a,b,c,d]`，若在各个租户订阅到的配置为`[i.a, i.b, i.c, i.d]`
 	2. 当需求分支服务进行CD时，向系统配置中心发起服务注册，系统配置中心生成将对应租户空间下的对应服务的配置。
 	 * 此时配置中心有配置`i: [a,b,c,d], f1: [a]`,当应用订阅四个服务获得的配置为`[f1.a, i.b, i.c, i.d]`
 	3. 当完成测试后清理服务时向系统配置中心注销服务与租户

如果仅考虑网络，可以考虑从平台、网络的层面实现依赖伪装，这样服务端可以不需要订阅对应配置。但仍需要服务注册流程用于开辟租户，生成伪装。

## 性能测试环境

部署参数与集成环境的集成分支策略类似，但需要更充足的资源，并且需要额外的手段允许测试人员调参。环境上可能会附加其他环境监测工具、性能测试工具和平台等。其他暂时没想清楚



## 预发环境和生产环境

在部署上可能需要考虑部署策略，例如金丝雀，因此需要更好的网络流量控制、存储隔离和版本控制



# 分支开发

## 分支开发与CI/CD触发

![branch](E:\study\distribute system\devops\images\CICD_devops-分支开发.png)

![cd](E:\study\distribute system\devops\images\CICD_devops-CD流程.png)

1. 创建需求后，开发人员从主线分支(develop)创建需求分支(feat)，进行开发后提交到需求分支，提交后触发CI和CD，将服务包部署到开发联调环境的对应命名空间下，并触发服务注册，网络流量配置。
2. 在开发联调环境完成初步测试后，确认需求可以进入主线集成阶段，此时由开发人员发起PR请求将需求分支合并到集成分支(devops-integrate)，需求负责人进行代码审核，或测试人员或其他人员进行相关审核
3. 集成分支PR通过后会触发集成分支对应的集成环境的cd，在集成环境下进行集成测试。
4. 当集成测试完成后，如果需要进行性能测试，则有性能测试人员通过性能测试环境的CD审核或手工触发对应包的CD，完成对性能测试环境的基础部署，随后通过手工调整参数的方式进行额外的调优手段。
5. 完成集成和性能测试后，测试人员提醒开发人员将集成分支合并到主线分支，合并到主线分支，主线分支CI将触发预发布环境的CD。因此此时开发经理对本次PR进行代码评审，质量负责人进行质量评估后通过PR
6. 预发环境CD触发后，相关人员进行质量验证、需求内部试营、验证等，确认无误后。通过生产环境的CD或手工触发，生产环境的CD由预发布环境CD完成后自动触发(或主线分支CI触发)，两个环境的区别在于不同的审核阶段。



## CI

![ci](E:\study\distribute system\devops\images\CICD_devops-CI.png)

CI主要流程如图，采用分阶段构建的方式将生产镜像与开发镜像分离。

1. 构建开发镜像
2. 通过开发镜像构建程序可执行程序，进行单元测试、基准性能测试和构建helm chart等(可自由发挥)
3. 构建生产环境的运行时环境
4. 归档输出包，例如镜像与helm chart上传仓库等
5. 清理环境

分阶段构建镜像时因为生产环境镜像往往不需要如同开发环境镜像一样负责，例如开发环境镜像需要编译工具，生产环境镜像并不需要，而带来好处有：

1. 降低生产环境镜像大小，降低镜像传输带来的成本
2. 简化生产镜像，减少可能出现的漏洞
3. 生产镜像的基础镜像可下沉有基础服务团队负责
4. 更好的镜像分层复用

未来考虑通过**服务定义**的方式让开发者构包时定义服务能力，在未来在CD时触发对应chart的生成，好处是：

1. 降低微服务开发者的能力要求
2. 服务定义云中立，微服务开发者不需要关注底层平台和平台版本
3. 上层微服务开发者，更专注于自身服务的开发、构建等问题，将集成问题从中剥离
4. 让容器编排平台拥有更灵活的方式，可以根据起编排策略，部署策略和网络管理策略对服务进行部署、管理。
   * 例如service在多版本管理下，需要有网络管理模块进行管理，有可能同时负责新旧版本两种服务
   * 部署后的部署名字可能会产生变化以支持同时支持多种版本等
   * ......

## CD

### 环境准备

在进行CD前需要根据环境定义完成环境资源准备和系统配置。

1. 集成环境需要进行如下准备
   1. 创建kubernetest集群
   2. 分配最小化的存储，完成存储卷的定义和分配(目前不考虑对有状态应用的处理，因此这里更多指的是有状态应用的手工部署)
   3. 部署对外开放的网络网关(可以CD触发部署)，提供证书等
   4. 系统配置中心、网络管理相关系统基础配置
   5. 一些公共组件部署和配置
   6. 全局参数配置
2. 开发联调环境需要如下准备
   1. 复用集成环境kubernetest集群
   2. 提供按分支名为基本策略，分配创建最小存储，完成需求开发分支所需持久卷的配置(目前不考虑有状态应用部署，先复用集成环境组件，未来该步骤可以考虑在CD中自动完成)
   3. 部署对外开放的网络网关(可以CD触发部署)，提供证书等
   4. 全局参数配置

### CD流程

![cd](E:\study\distribute system\devops\images\CICD_devops-CD.png)

![rollback](E:\study\distribute system\devops\images\CICD_devops-回滚.png)

#### 集成分支CD

1. 进行升级工作
2. 注册itegeation租户(业务上)
3. **服务注册(系统配置中心)**
4. 生成服务所需配置(例如 hydra密钥 token等)
5. 部署helm chart
6. **配置网络路由**
7. 触发性能测试环境CD(看情况)

#### 需求分支CD

1. 进行升级工作
2. 注册itegeation租户(业务上)
3. **服务注册(系统配置中心)**
4. 生成服务所需配置(例如 hydra密钥 token等)
5. 部署helm chart
6. **配置网络路由**

#### 性能分支CD

CD部分同集成，特殊参数调优目前未能提炼共性，暂由测试人员手工完成。

#### 预发分支CD

暂时考虑与集成分支相同，未来可能会采用其他的部署策略，例如金丝雀部署等。需要强大的网络流量控制能力、多版本服务实例控制机制等支持。

#### 生产环境CD

目前类似预发布环境，但是该环境下不会创建租户。未来需要考虑多租户和多区域下服务是否需要升级等版本管理问题





# 微服务要求

## 服务定义

通过服务定义，表明该服务到底提供了什么样的能力，提供了哪些能力，对方应该如何访问这些能力。整体系统根据服务定义决定微服务可以享受的权利与应该受到的限制。

难：一个微服务包里面可以有几个进程组(pod)，每个deployment里有多少个进程(container)对外服务

| 字段名         | 类型   | 描述         |
| -------------- | ------ | ------------ |
| DefinedVersion | string | 定义模板版本 |
| protocol       | string | 通信协议     |
| serviceName    |        |              |
|                |        |              |
|                |        |              |



### 服务要求实现

1. 服务健康探针接口
2. 服务自检接口，描述服务状态与异常
3. 服务系统配置订阅，按策略订阅系统配置中心(配置中心该如何规划)中的配置
   1. 例如网络配置订阅，用于订阅服务依赖

